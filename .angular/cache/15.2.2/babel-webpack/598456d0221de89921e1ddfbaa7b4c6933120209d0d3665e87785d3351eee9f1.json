{"ast":null,"code":"import _asyncToGenerator from \"E:/work/pigallery2/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { TemplateRef } from '@angular/core';\nimport { AutoCompleteService } from './autocomplete.service';\nimport { ActivatedRoute, Router, RouterLink } from '@angular/router';\nimport { ContentService } from '../content.service';\nimport { NavigationService } from '../../../model/navigation.service';\nimport { QueryParams } from '../../../../../common/QueryParams';\nimport { MetadataSearchQueryTypes, SearchQueryTypes } from '../../../../../common/entities/SearchQueryDTO';\nimport { BsModalService } from 'ngx-bootstrap/modal';\nimport { SearchQueryParserService } from './search-query-parser.service';\nimport { AlbumsService } from '../../albums/albums.service';\nimport { Config } from '../../../../../common/config/public/Config';\nimport { UserRoles } from '../../../../../common/entities/UserDTO';\nimport { AuthenticationService } from '../../../model/network/authentication.service';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./autocomplete.service\";\nimport * as i2 from \"./search-query-parser.service\";\nimport * as i3 from \"../content.service\";\nimport * as i4 from \"../../albums/albums.service\";\nimport * as i5 from \"../../../model/navigation.service\";\nimport * as i6 from \"@angular/router\";\nimport * as i7 from \"ngx-bootstrap/modal\";\nimport * as i8 from \"../../../model/network/authentication.service\";\nimport * as i9 from \"@angular/common\";\nimport * as i10 from \"@angular/forms\";\nimport * as i11 from \"../../albums/saved-search-popup/saved-search-popup.component\";\nimport * as i12 from \"./search-field-base/search-field-base.gallery.component\";\nimport * as i13 from \"./query-builder/query-bulder.gallery.component\";\nfunction GallerySearchComponent_ng_template_8_button_11_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 25);\n    i0.ɵɵlistener(\"click\", function GallerySearchComponent_ng_template_8_button_11_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r7 = i0.ɵɵnextContext(2);\n      const _r3 = i0.ɵɵreference(11);\n      return i0.ɵɵresetView(ctx_r7.openSaveSearchModal(_r3));\n    });\n    i0.ɵɵelement(1, \"span\", 26);\n    i0.ɵɵelementContainerStart(2);\n    i0.ɵɵi18n(3, 27);\n    i0.ɵɵelementContainerEnd();\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r6 = i0.ɵɵnextContext(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r6.rawSearchText == \"\");\n  }\n}\nconst _c6 = function (a1) {\n  return [\"/search\", a1];\n};\nfunction GallerySearchComponent_ng_template_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 10)(1, \"h5\", 11);\n    i0.ɵɵi18n(2, 12);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 13);\n    i0.ɵɵlistener(\"click\", function GallerySearchComponent_ng_template_8_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r9 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r9.hideSearchModal());\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 14)(5, \"form\", 15, 16)(7, \"app-gallery-search-query-builder\", 17);\n    i0.ɵɵlistener(\"ngModelChange\", function GallerySearchComponent_ng_template_8_Template_app_gallery_search_query_builder_ngModelChange_7_listener($event) {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r11 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r11.searchQueryDTO = $event);\n    })(\"change\", function GallerySearchComponent_ng_template_8_Template_app_gallery_search_query_builder_change_7_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r12 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r12.onQueryChange());\n    })(\"search\", function GallerySearchComponent_ng_template_8_Template_app_gallery_search_query_builder_search_7_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r13 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r13.Search());\n    });\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(8, \"div\", 18)(9, \"div\", 19)(10, \"div\", 20);\n    i0.ɵɵtemplate(11, GallerySearchComponent_ng_template_8_button_11_Template, 4, 1, \"button\", 21);\n    i0.ɵɵelementStart(12, \"button\", 22);\n    i0.ɵɵlistener(\"click\", function GallerySearchComponent_ng_template_8_Template_button_click_12_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r14 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r14.hideSearchModal());\n    });\n    i0.ɵɵelement(13, \"span\", 23);\n    i0.ɵɵelementContainerStart(14);\n    i0.ɵɵi18n(15, 24);\n    i0.ɵɵelementContainerEnd();\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngModel\", ctx_r2.searchQueryDTO);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", ctx_r2.CanCreateAlbum);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"routerLink\", i0.ɵɵpureFunction1(3, _c6, ctx_r2.HTMLSearchQuery));\n  }\n}\nconst _c15 = function (a0, a1) {\n  return {\n    name: a0,\n    searchQuery: a1\n  };\n};\nfunction GallerySearchComponent_ng_template_10_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r17 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 10)(1, \"h5\", 11);\n    i0.ɵɵi18n(2, 28);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 13);\n    i0.ɵɵlistener(\"click\", function GallerySearchComponent_ng_template_10_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r17);\n      const ctx_r16 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r16.hideSaveSearchModal());\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 14)(5, \"form\", 15, 29)(7, \"div\", 30)(8, \"label\", 31);\n    i0.ɵɵi18n(9, 32);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"input\", 33);\n    i0.ɵɵlistener(\"ngModelChange\", function GallerySearchComponent_ng_template_10_Template_input_ngModelChange_10_listener($event) {\n      i0.ɵɵrestoreView(_r17);\n      const ctx_r18 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r18.saveSearchName = $event);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(11, \"div\", 34)(12, \"div\", 20);\n    i0.ɵɵelement(13, \"app-saved-search-popup-btn\", 35);\n    i0.ɵɵelementStart(14, \"button\", 36);\n    i0.ɵɵlistener(\"click\", function GallerySearchComponent_ng_template_10_Template_button_click_14_listener() {\n      i0.ɵɵrestoreView(_r17);\n      const ctx_r19 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r19.saveSearch());\n    });\n    i0.ɵɵelement(15, \"span\", 26);\n    i0.ɵɵelementContainerStart(16);\n    i0.ɵɵi18n(17, 37);\n    i0.ɵɵelementContainerEnd();\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r4 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(10);\n    i0.ɵɵproperty(\"ngModel\", ctx_r4.saveSearchName);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"disabled\", ctx_r4.saveSearchName == \"\")(\"savedSearchDTO\", i0.ɵɵpureFunction2(4, _c15, ctx_r4.saveSearchName, ctx_r4.searchQueryDTO));\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"disabled\", ctx_r4.saveSearchName == \"\");\n  }\n}\nexport let GallerySearchComponent = /*#__PURE__*/(() => {\n  class GallerySearchComponent {\n    constructor(autoCompleteService, searchQueryParserService, galleryService, albumService, navigationService, route, router, modalService, authenticationService) {\n      this.autoCompleteService = autoCompleteService;\n      this.searchQueryParserService = searchQueryParserService;\n      this.galleryService = galleryService;\n      this.albumService = albumService;\n      this.navigationService = navigationService;\n      this.route = route;\n      this.router = router;\n      this.modalService = modalService;\n      this.authenticationService = authenticationService;\n      this.searchQueryDTO = {\n        type: SearchQueryTypes.any_text,\n        text: ''\n      };\n      this.rawSearchText = '';\n      this.mouseOverAutoComplete = false;\n      this.saveSearchName = '';\n      this.subscription = null;\n      this.SearchQueryTypes = SearchQueryTypes;\n      this.MetadataSearchQueryTypes = MetadataSearchQueryTypes.map(v => ({\n        key: v,\n        value: SearchQueryTypes[v]\n      }));\n      this.subscription = this.route.params.subscribe(params => {\n        if (!params[QueryParams.gallery.search.query]) {\n          return;\n        }\n        const searchQuery = JSON.parse(params[QueryParams.gallery.search.query]);\n        if (searchQuery) {\n          this.searchQueryDTO = searchQuery;\n          this.onQueryChange();\n        }\n      });\n    }\n    get CanCreateAlbum() {\n      return Config.Album.enabled && this.authenticationService.user.getValue().role >= UserRoles.Admin;\n    }\n    get HTMLSearchQuery() {\n      return JSON.stringify(this.searchQueryDTO);\n    }\n    ngOnDestroy() {\n      if (this.subscription !== null) {\n        this.subscription.unsubscribe();\n      }\n    }\n    openSearchModal(template) {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        _this.searchModalRef = _this.modalService.show(template, {\n          class: 'modal-lg'\n        });\n        document.body.style.paddingRight = '0px';\n      })();\n    }\n    hideSearchModal() {\n      this.searchModalRef.hide();\n      this.searchModalRef = null;\n    }\n    openSaveSearchModal(template) {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        _this2.saveSearchModalRef = _this2.modalService.show(template, {\n          class: 'modal-lg'\n        });\n        document.body.style.paddingRight = '0px';\n      })();\n    }\n    hideSaveSearchModal() {\n      this.saveSearchModalRef.hide();\n      this.saveSearchModalRef = null;\n    }\n    onQueryChange() {\n      this.rawSearchText = this.searchQueryParserService.stringify(this.searchQueryDTO);\n      // this.validateRawSearchText();\n    }\n\n    validateRawSearchText() {\n      try {\n        this.searchQueryDTO = this.searchQueryParserService.parse(this.rawSearchText);\n      } catch (e) {\n        console.error(e);\n      }\n    }\n    Search() {\n      this.router.navigate(['/search', this.HTMLSearchQuery]).catch(console.error);\n    }\n    saveSearch() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        yield _this3.albumService.addSavedSearch(_this3.saveSearchName, _this3.searchQueryDTO);\n        _this3.hideSaveSearchModal();\n      })();\n    }\n  }\n  GallerySearchComponent.ɵfac = function GallerySearchComponent_Factory(t) {\n    return new (t || GallerySearchComponent)(i0.ɵɵdirectiveInject(i1.AutoCompleteService), i0.ɵɵdirectiveInject(i2.SearchQueryParserService), i0.ɵɵdirectiveInject(i3.ContentService), i0.ɵɵdirectiveInject(i4.AlbumsService), i0.ɵɵdirectiveInject(i5.NavigationService), i0.ɵɵdirectiveInject(i6.ActivatedRoute), i0.ɵɵdirectiveInject(i6.Router), i0.ɵɵdirectiveInject(i7.BsModalService), i0.ɵɵdirectiveInject(i8.AuthenticationService));\n  };\n  GallerySearchComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: GallerySearchComponent,\n    selectors: [[\"app-gallery-search\"]],\n    features: [i0.ɵɵProvidersFeature([AutoCompleteService, RouterLink])],\n    decls: 12,\n    vars: 4,\n    consts: function () {\n      let i18n_0;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_4580988005648117665$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__1 = goog.getMsg(\"Search\");\n        i18n_0 = MSG_EXTERNAL_4580988005648117665$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__1;\n      } else {\n        i18n_0 = $localize`Search`;\n      }\n      let i18n_2;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_4580988005648117665$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__3 = goog.getMsg(\"Search\");\n        i18n_2 = MSG_EXTERNAL_4580988005648117665$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__3;\n      } else {\n        i18n_2 = $localize`Search`;\n      }\n      let i18n_4;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_3768927257183755959$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS___5 = goog.getMsg(\"Save\");\n        i18n_4 = MSG_EXTERNAL_3768927257183755959$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS___5;\n      } else {\n        i18n_4 = $localize`Save`;\n      }\n      let i18n_7;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_5466947574428856253$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__8 = goog.getMsg(\"Save search to album\");\n        i18n_7 = MSG_EXTERNAL_5466947574428856253$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__8;\n      } else {\n        i18n_7 = $localize`Save search to album`;\n      }\n      let i18n_9;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_8002146750272130034$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__10 = goog.getMsg(\"Album name\");\n        i18n_9 = MSG_EXTERNAL_8002146750272130034$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__10;\n      } else {\n        i18n_9 = $localize`Album name`;\n      }\n      let i18n_11;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_8002146750272130034$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__12 = goog.getMsg(\"Album name\");\n        i18n_11 = MSG_EXTERNAL_8002146750272130034$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__12;\n      } else {\n        i18n_11 = $localize`Album name`;\n      }\n      let i18n_13;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_4606777540690493351$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__14 = goog.getMsg(\"Save as album\");\n        i18n_13 = MSG_EXTERNAL_4606777540690493351$$SRC_FRONTEND_APP_UI_GALLERY_SEARCH_SEARCH_GALLERY_COMPONENT_TS__14;\n      } else {\n        i18n_13 = $localize`Save as album`;\n      }\n      return [[\"role\", \"search\", 1, \"navbar-form\"], [\"SearchForm\", \"ngForm\"], [1, \"input-group\", \"flex-nowrap\", 2, \"place-content\", \"flex-end\"], [\"name\", \"search-field\", 1, \"search-field\", \"form-control\", \"p-0\", 3, \"ngModel\", \"ngModelChange\", \"search\"], [\"type\", \"button\", 1, \"btn\", \"btn-light\", 3, \"routerLink\"], [1, \"oi\", \"oi-magnifying-glass\"], [\"type\", \"button\", 1, \"btn\", \"btn-light\", 3, \"click\"], [1, \"oi\", \"oi-chevron-bottom\"], [\"searchModal\", \"\"], [\"saveSearchModal\", \"\"], [1, \"modal-header\"], [1, \"modal-title\"], i18n_0, [\"type\", \"button\", \"data-dismiss\", \"modal\", \"aria-label\", \"Close\", 1, \"btn-close\", 3, \"click\"], [1, \"modal-body\"], [1, \"form-horizontal\"], [\"searchPanelForm\", \"ngForm\"], [\"name\", \"search-query-builder\", 3, \"ngModel\", \"ngModelChange\", \"change\", \"search\"], [1, \"modal-footer\"], [1, \"btn-group\", \"float-end\", \"row\", 2, \"display\", \"block\"], [1, \"pe-0\"], [\"class\", \"btn btn-secondary me-2\", \"type\", \"button\", 3, \"disabled\", \"click\", 4, \"ngIf\"], [\"type\", \"button\", 1, \"btn\", \"btn-primary\", 3, \"routerLink\", \"click\"], [1, \"oi\", \"oi-magnifying-glass\", \"me-2\"], i18n_2, [\"type\", \"button\", 1, \"btn\", \"btn-secondary\", \"me-2\", 3, \"disabled\", \"click\"], [1, \"oi\", \"oi-folder\", \"me-2\"], i18n_4, i18n_7, [\"saveSearchPanelForm\", \"ngForm\"], [1, \"mb-1\"], [\"for\", \"saveSearchName\"], i18n_9, [\"id\", \"saveSearchName\", \"name\", \"saveSearchName\", \"placeholder\", i18n_11, \"required\", \"required\", \"type\", \"text\", 1, \"form-control\", \"input-md\", 3, \"ngModel\", \"ngModelChange\"], [\"role\", \"group\", 1, \"btn-group\", \"float-end\", \"row\", \"mt-2\", 2, \"display\", \"block\"], [1, \"me-2\", 3, \"disabled\", \"savedSearchDTO\"], [\"type\", \"button\", 1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], i18n_13];\n    },\n    template: function GallerySearchComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        const _r20 = i0.ɵɵgetCurrentView();\n        i0.ɵɵelementStart(0, \"form\", 0, 1)(2, \"div\", 2)(3, \"app-gallery-search-field-base\", 3);\n        i0.ɵɵlistener(\"ngModelChange\", function GallerySearchComponent_Template_app_gallery_search_field_base_ngModelChange_3_listener($event) {\n          return ctx.rawSearchText = $event;\n        })(\"ngModelChange\", function GallerySearchComponent_Template_app_gallery_search_field_base_ngModelChange_3_listener() {\n          return ctx.validateRawSearchText();\n        })(\"search\", function GallerySearchComponent_Template_app_gallery_search_field_base_search_3_listener() {\n          return ctx.Search();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(4, \"button\", 4);\n        i0.ɵɵelement(5, \"span\", 5);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(6, \"button\", 6);\n        i0.ɵɵlistener(\"click\", function GallerySearchComponent_Template_button_click_6_listener() {\n          i0.ɵɵrestoreView(_r20);\n          const _r1 = i0.ɵɵreference(9);\n          return i0.ɵɵresetView(ctx.openSearchModal(_r1));\n        });\n        i0.ɵɵelement(7, \"span\", 7);\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵtemplate(8, GallerySearchComponent_ng_template_8_Template, 16, 5, \"ng-template\", null, 8, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(10, GallerySearchComponent_ng_template_10_Template, 18, 7, \"ng-template\", null, 9, i0.ɵɵtemplateRefExtractor);\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngModel\", ctx.rawSearchText);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"routerLink\", i0.ɵɵpureFunction1(2, _c6, ctx.HTMLSearchQuery));\n      }\n    },\n    dependencies: [i9.NgIf, i10.ɵNgNoValidate, i10.DefaultValueAccessor, i10.NgControlStatus, i10.NgControlStatusGroup, i10.RequiredValidator, i10.NgModel, i10.NgForm, i6.RouterLink, i11.SavedSearchPopupComponent, i12.GallerySearchFieldBaseComponent, i13.GallerySearchQueryBuilderComponent],\n    styles: [\"form[_ngcontent-%COMP%]{padding-right:1em}@media screen and (min-width: 1200px){.search-field[_ngcontent-%COMP%]{max-width:400px}}@media screen and (min-width: 1400px){.search-field[_ngcontent-%COMP%]{max-width:500px}}\"]\n  });\n  return GallerySearchComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}