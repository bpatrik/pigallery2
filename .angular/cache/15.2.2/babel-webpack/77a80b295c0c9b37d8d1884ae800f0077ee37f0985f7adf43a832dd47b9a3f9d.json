{"ast":null,"code":"import { DuplicateService } from './duplicates.service';\nimport { Utils } from '../../../../common/Utils';\nimport { QueryService } from '../../model/query.service';\nimport { Config } from '../../../../common/config/public/Config';\nimport { PageHelper } from '../../model/page.helper';\nimport { PiTitleService } from '../../model/pi-title.service';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./duplicates.service\";\nimport * as i2 from \"../../model/query.service\";\nimport * as i3 from \"../../model/pi-title.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/router\";\nimport * as i6 from \"../frame/frame.component\";\nimport * as i7 from \"./photo/photo.duplicates.component\";\nimport * as i8 from \"../../pipes/FileSizePipe\";\nfunction DuplicateComponent_ng_template_2_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 4);\n    i0.ɵɵtext(1, \" Listing \");\n    i0.ɵɵelementStart(2, \"strong\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(ctx_r2.duplicateCount.pairs);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" duplicates (\", ctx_r2.duplicateCount.photos, \" photos). \");\n  }\n}\nfunction DuplicateComponent_ng_template_2_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 4);\n    i0.ɵɵi18n(1, 5);\n    i0.ɵɵelementEnd();\n  }\n}\nconst _c2 = function (a1) {\n  return [\"/gallery\", a1];\n};\nfunction DuplicateComponent_ng_template_2_div_2_div_3_a_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"a\", 10);\n    i0.ɵɵelement(1, \"app-duplicates-photo\", 11);\n    i0.ɵɵelementStart(2, \"div\", 12);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementStart(4, \"strong\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"div\", 13);\n    i0.ɵɵtext(7);\n    i0.ɵɵpipe(8, \"fileSize\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"div\", 14);\n    i0.ɵɵtext(10);\n    i0.ɵɵpipe(11, \"date\");\n    i0.ɵɵpipe(12, \"date\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const media_r9 = ctx.$implicit;\n    const ctx_r8 = i0.ɵɵnextContext(4);\n    i0.ɵɵproperty(\"routerLink\", i0.ɵɵpureFunction1(16, _c2, ctx_r8.getDirectoryPath(media_r9.directory)))(\"queryParams\", ctx_r8.queryService.getParams());\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"media\", media_r9);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" /\", ctx_r8.getDirectoryPath(media_r9.directory), \"/\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(media_r9.name);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(8, 9, media_r9.metadata.fileSize), \" \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"title\", media_r9.metadata.creationDate);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate2(\" \", i0.ɵɵpipeBind1(11, 11, media_r9.metadata.creationDate), \", \", i0.ɵɵpipeBind2(12, 13, media_r9.metadata.creationDate, \"mediumTime\"), \" \");\n  }\n}\nfunction DuplicateComponent_ng_template_2_div_2_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 7)(1, \"div\", 8);\n    i0.ɵɵtemplate(2, DuplicateComponent_ng_template_2_div_2_div_3_a_2_Template, 13, 18, \"a\", 9);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const pairs_r7 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", pairs_r7.media);\n  }\n}\nfunction DuplicateComponent_ng_template_2_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"strong\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, DuplicateComponent_ng_template_2_div_2_div_3_Template, 3, 1, \"div\", 6);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const group_r5 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(group_r5.name);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngForOf\", group_r5.duplicates);\n  }\n}\nfunction DuplicateComponent_ng_template_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtemplate(0, DuplicateComponent_ng_template_2_div_0_Template, 5, 2, \"div\", 2);\n    i0.ɵɵtemplate(1, DuplicateComponent_ng_template_2_div_1_Template, 2, 0, \"div\", 2);\n    i0.ɵɵtemplate(2, DuplicateComponent_ng_template_2_div_2_Template, 4, 2, \"div\", 3);\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.duplicateCount.photos > 0);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.duplicateCount.photos == 0);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r0.renderedDirGroups);\n  }\n}\nfunction DuplicateComponent_ng_template_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtext(0, \" loading \");\n  }\n}\nexport let DuplicateComponent = /*#__PURE__*/(() => {\n  class DuplicateComponent {\n    constructor(duplicateService, queryService, piTitleService) {\n      this.duplicateService = duplicateService;\n      this.queryService = queryService;\n      this.piTitleService = piTitleService;\n      this.directoryGroups = null;\n      this.renderedDirGroups = null;\n      this.renderedIndex = {\n        group: -1,\n        pairs: 0\n      };\n      this.renderTimer = null;\n      this.duplicateCount = {\n        pairs: 0,\n        photos: 0\n      };\n      this.renderMore = () => {\n        if (this.renderTimer !== null) {\n          clearTimeout(this.renderTimer);\n          this.renderTimer = null;\n        }\n        if (this.directoryGroups.length === 0) {\n          return;\n        }\n        if (this.renderedIndex.group === this.directoryGroups.length - 1 && this.renderedIndex.pairs >= this.directoryGroups[this.renderedIndex.group].duplicates.length) {\n          return;\n        }\n        if (this.shouldRenderMore()) {\n          if (this.renderedDirGroups.length === 0 || this.renderedIndex.pairs >= this.directoryGroups[this.renderedIndex.group].duplicates.length) {\n            this.renderedDirGroups.push({\n              name: this.directoryGroups[++this.renderedIndex.group].name,\n              duplicates: []\n            });\n            this.renderedIndex.pairs = 0;\n          }\n          this.renderedDirGroups[this.renderedDirGroups.length - 1].duplicates.push(this.directoryGroups[this.renderedIndex.group].duplicates[this.renderedIndex.pairs++]);\n          this.renderTimer = window.setTimeout(this.renderMore, 0);\n        }\n      };\n      this.duplicateService.getDuplicates().catch(console.error);\n      this.subscription = this.duplicateService.duplicates.subscribe(duplicates => {\n        this.directoryGroups = [];\n        this.renderedIndex = {\n          group: -1,\n          pairs: 0\n        };\n        this.renderedDirGroups = [];\n        this.duplicateCount = {\n          pairs: 0,\n          photos: 0\n        };\n        if (duplicates === null) {\n          return;\n        }\n        this.duplicateCount.photos = duplicates.reduce((prev, curr) => prev + curr.media.length, 0);\n        this.duplicateCount.pairs = duplicates.length;\n        const getMostFrequentDir = dupls => {\n          if (dupls.length === 0) {\n            return null;\n          }\n          const dirFrequency = {};\n          dupls.forEach(d => d.media.forEach(m => {\n            const k = Utils.concatUrls(m.directory.path, m.directory.name);\n            dirFrequency[k] = dirFrequency[k] || {\n              dir: m.directory,\n              count: 0\n            };\n            dirFrequency[k].count++;\n          }));\n          let max = {\n            count: -1,\n            dir: null\n          };\n          for (const freq of Object.values(dirFrequency)) {\n            if (max.count <= freq.count) {\n              max = freq;\n            }\n          }\n          return max.dir;\n        };\n        while (duplicates.length > 0) {\n          const dir = getMostFrequentDir(duplicates);\n          const group = duplicates.filter(d => d.media.find(m => m.directory.name === dir.name && m.directory.path === dir.path));\n          duplicates = duplicates.filter(d => !d.media.find(m => m.directory.name === dir.name && m.directory.path === dir.path));\n          this.directoryGroups.push({\n            name: this.getDirectoryPath(dir) + ' (' + group.length + ')',\n            duplicates: group\n          });\n        }\n        this.renderMore();\n      });\n    }\n    ngOnInit() {\n      this.piTitleService.setTitle($localize`Duplicates`);\n    }\n    ngOnDestroy() {\n      if (this.subscription) {\n        this.subscription.unsubscribe();\n        this.subscription = null;\n      }\n    }\n    getDirectoryPath(directory) {\n      return Utils.concatUrls(directory.path, directory.name);\n    }\n    onScroll() {\n      this.renderMore();\n    }\n    shouldRenderMore() {\n      return Config.Gallery.enableOnScrollRendering === false || PageHelper.ScrollY >= PageHelper.MaxScrollY * 0.7 || document.body.clientHeight * 0.85 < window.innerHeight;\n    }\n  }\n  DuplicateComponent.ɵfac = function DuplicateComponent_Factory(t) {\n    return new (t || DuplicateComponent)(i0.ɵɵdirectiveInject(i1.DuplicateService), i0.ɵɵdirectiveInject(i2.QueryService), i0.ɵɵdirectiveInject(i3.PiTitleService));\n  };\n  DuplicateComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: DuplicateComponent,\n    selectors: [[\"app-duplicate\"]],\n    hostBindings: function DuplicateComponent_HostBindings(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵlistener(\"scroll\", function DuplicateComponent_scroll_HostBindingHandler() {\n          return ctx.onScroll();\n        }, false, i0.ɵɵresolveWindow);\n      }\n    },\n    decls: 4,\n    vars: 2,\n    consts: function () {\n      let i18n_0;\n      if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n        /**\r\n         * @suppress {msgDescriptions}\r\n         */\n        const MSG_EXTERNAL_6627551199474162394$$SRC_FRONTEND_APP_UI_DUPLICATES_DUPLICATES_COMPONENT_TS___1 = goog.getMsg(\" No duplicates found \");\n        i18n_0 = MSG_EXTERNAL_6627551199474162394$$SRC_FRONTEND_APP_UI_DUPLICATES_DUPLICATES_COMPONENT_TS___1;\n      } else {\n        i18n_0 = $localize` No duplicates found `;\n      }\n      return [[\"body\", \"\", 1, \"container\"], [3, \"ngIf\"], [\"class\", \"alert alert-secondary\", \"role\", \"alert\", 4, \"ngIf\"], [4, \"ngFor\", \"ngForOf\"], [\"role\", \"alert\", 1, \"alert\", \"alert-secondary\"], i18n_0, [\"class\", \"card\", 4, \"ngFor\", \"ngForOf\"], [1, \"card\"], [1, \"card-body\"], [\"class\", \"row text-body rounded-2 p-2\", 3, \"routerLink\", \"queryParams\", 4, \"ngFor\", \"ngForOf\"], [1, \"row\", \"text-body\", \"rounded-2\", \"p-2\", 3, \"routerLink\", \"queryParams\"], [1, \"col-1\", \"align-self-center\", 3, \"media\"], [1, \"col-6\", \"align-self-center\"], [1, \"col-2\", \"align-self-center\"], [1, \"col-3\", \"align-self-center\", 3, \"title\"]];\n    },\n    template: function DuplicateComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"app-frame\")(1, \"div\", 0);\n        i0.ɵɵtemplate(2, DuplicateComponent_ng_template_2_Template, 3, 3, \"ng-template\", 1);\n        i0.ɵɵtemplate(3, DuplicateComponent_ng_template_3_Template, 1, 0, \"ng-template\", 1);\n        i0.ɵɵelementEnd()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", ctx.renderedDirGroups);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", !ctx.renderedDirGroups);\n      }\n    },\n    dependencies: [i4.NgForOf, i4.NgIf, i5.RouterLink, i6.FrameComponent, i7.DuplicatesPhotoComponent, i4.DatePipe, i8.FileSizePipe],\n    styles: [\".card[_ngcontent-%COMP%]{margin:8px 0}.row[_ngcontent-%COMP%]{margin:5px 0;cursor:pointer}.row[_ngcontent-%COMP%]:hover{background-color:var(--bs-tertiary-bg)}\"]\n  });\n  return DuplicateComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}